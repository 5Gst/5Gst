name: "BALANCER___Publish_docker_image_to_Docker_Hub"

on: 
  workflow_run:
    workflows: ["BALANCER___API_client_generation_using_swagger"]
    types:
      - completed

jobs:

  balancer-makemigartions:
    #if: github.event_name == 'push'
    runs-on: ubuntu-latest
    env:
      SECRET_KEY: test
      DB_NAME: test
      DB_USER: test
      DB_PASSWORD: test
      DB_HOST: test
      DB_PORT: test
    defaults:
      run:
        working-directory: ./balancer
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python 3.8
      uses: actions/setup-python@v3
      with:
        python-version: 3.8
    - name: make migrations
      run: |
       python -m pip install --upgrade pip
       pip install pipenv
       pipenv install
       pipenv run python manage.py makemigrations
       
    - name: push changes to git
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "generated migration scripts"
        file_pattern: balancer/services/migrations 
        
        

  #needs нужен для порядка и проверки что предыдущий степ выполнен (тип выполнение нового степа будет ток после того как степ из нидс хорошо отработает, 
  #если не отработает - новый степ не запустится ), а always нужен чтоб если даже из нидс степ не выполнен, 
  #то новый степ в любом случае выполнился (тип гарантирует, что новый степ всегда будет выполнен вне зависимости от других обстоятельств)
  balancer-test:
    needs: balancer-makemigartions
    runs-on: ubuntu-latest
    env:
      SECRET_KEY: test
      TEST_MODE: "True"
    defaults:
      run:
        working-directory: ./balancer
    steps:
    - uses: actions/checkout@main
    - name: Set up Python 3.8
      uses: actions/setup-python@v3
      with:
        python-version: 3.8
    - name: Install pip, pipenv and packages from Pipfile
      run: |
        python -m pip install --upgrade pip
        pip install pipenv
        pipenv install --dev
    - name: Run tests
      run: |
        pipenv run test





  publish-to-dockerhub:
    runs-on: ubuntu-latest
    needs: balancer-test
    defaults:
      run:
        working-directory: ./balancer
    steps:
      - uses: actions/checkout@v2
      
      - name: Setup version variable
        run: |
          echo "version=$(cat ../VERSION)" > $GITHUB_ENV
          
      - name: build docker image
        if: github.repository != '5gst/5gst'
        run: docker build . --tag new_balancer_image:${{ env.version }}.${{ github.run_number }}

      - name: Log in to Docker Hub
        if: |
          github.repository == '5gst/5gst' && github.event_name == 'push'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_ACCESS_TOKEN }}

      - name: Build and push Docker image
        if: |
          github.repository == '5gst/5gst' && github.event_name == 'push'
        uses: docker/build-push-action@v2
        with:
          context: ./balancer
          push: true
          tags: 5gst/speedtest-balancer:${{ env.version }}.${{ github.run_number }}, 5gst/speedtest-balancer:latest


